
*                _              _       _
 _ __ ___   __ _| | _____    __| | __ _| |_ __ _
| '_ ` _ \ / _` | |/ / _ \  / _` |/ _` | __/ _` |
| | | | | | (_| |   <  __/ | (_| | (_| | || (_| |
|_| |_| |_|\__,_|_|\_\___|  \__,_|\__,_|\__\__,_|

;

options validvarname=upcase;
libname sd1 "d:/sd1";
data sd1.have;
call streaminit(5732);
informat str $10.;
input str$ @@;
room_rate=input(substr(str,1,4),4.);
lat=30+input(substr(str,5,3),3.)/1000;
lon=-1*(97+input(substr(str,8,3),3.)/1000);
if room_rate > 250 and room_rate < 1000 and rand("uniform") > .25 then room_rate=room_rate+1000;
drop str;;
cards4;
0082310732 0110244775 0119300779 0105278719 0050233589 0130230766 0135343736 0199250722
0454266741 0201205878 0074224783 0042276713 0169283708 0410338824 0160266733 0187188816
0079267690 0139275758 0130192782 0040193731 0550276626 0043247779 0097277735 0033346688
0199271741 0099283829 0083252778 0035216859 0364274730 0399232780 0135265700 0037310691
0075295713 0076191778 0054383768 0059193818 0054348752 0152320684 0180391701 0150386680
0099380956 0260136632 0155252725 0037457816 0041309691 0049413749 0030239579 0087316745
0040396655 0350266609 0045259863 0034230732 0070375649 0300281838 0070209857 1495394918
0400323789 0069298826 0119271728 0040461756 0041426694 0098245740 0071217859 0040276625
0399161634 0090366895 1000271729 0095272725 0150246911 0098400846 0050288771 0040230590
0050362646 0250251724 0199245999 0030212817 0036183802 0900169613 0295266740 0033347689
0175266740 0118224917 0289284649 0155125813 0060414713 0269236999 0050279705 0048288748
0110420924 0040283628 0069242874 0150280692 0202233980 0099251759 0120307726 0165261772
0118293723 0085277722 0299265743 0044238765 0044284648 0077232734 0995369930 0180275708
0134260754 0150289769 0054452783 0098277624 0055283690 0300208867 0123257726 0070196700
0120258698 0069229744 0089326766 0047191732 0295232590 0135246772 0175250874 0063388658
0070285750 0050254717 0160292760 0100251745 0061279771 0037310691 0099281740 0145385957
0099234780 0075238579 0085210776 0109355797 0160330864 0100250756 0129285637 0230346619
0054362645 0165321722 0100291719 0120261773 1200248561 0042237880 0229279761 0055318675
0062383873 0125283759 0037272727 0049281623 0062383873 0060414713 0800289644 0075265717
0059254800 0075290773 0075274631 0190253718 0070221727 0100281711 0122266784 0042228848
0090250782 0275289641 0150245753 0110286716 0130265704 0125205933 0075270811 0129285636
0080235586 0036326683 0149226755 0120239746 0054246772 0174237760 0050381893 0220384882
0043241578 0149305673 0155293722 0045314918 0047383876 0020165626 0325281648 0055318675
0035424697 0036326683 0040364610 0050397659 0155392699 0249313672 0060365676 0049281623
0080440668 0030435673 0054329648 0044367680 0040228589 0075393642 0066350617 0049370651
0041426695 0063388658 0138335651 0038283623 0032321675 0150406650 0030430691 0050356642
0080334649 0049353609 0055397654 0250238580 0200442682 0099320682 0040276625 0239370672
0063369652 0070440694 0066397649 0022346688 0100355613 0050346615 0040328683 0599443681
0154369652 0038412716 0150437677 1000366612 0057387656 0065415679 0042426694 0060412716
0050362646 0055381650 0039426694 0110405653 0042389667 0045398656 0040319677 0054373703
0253346617 0100374650 0350266609 0069283623 0050363646 0126413699 0250356617 0545390668
0060383664 0150363644 0150394650 0215348622 0469308674 0950261723 0092310757 0135243785
0098320684 0130248726 0149277752 0123277713 0119285723 0125279723 0109291759 0066282623
0050412694 0035345610 0034367694 0050358647 0200429685 0199278781 0090297683 0035392691
0040335650 0100252775 0069262761 0095159638 0099344727 0035380672 0199268746 0125261735
0095313714 0425453687 0110170618 0129320684 0016282623 0169283708 0175322738 0063388658
0065377703 0118278753 0099313750 0035304734 0075386749 0094332737 0145252769 0072283758
0081343737 0040184828 0116269722 0115413697 0050197731 0120248723 0040238573 0096245739
0035291751 0215315697 0099408670 0600262732 0138335651 0039151742 0050194828 0099262762
0055302671 0450331714 0045335732 0031459784 0122258777 0133275726 0124319731 0095256725
0109355797 0030430691 0079341716 0179404652 0045356610 0150279748 0115307730 0295370664
0112304678 0199417889 0099333737 0029460682 0120256714 0228368651 0060372651 0325308919
0070252745 0035358698 0039394704 0125374660 0145257756 0094312723 0349266735 0079274727
0113260733 0109313725 0102279752 1400265734 0364274730 0079343717 0399256733 0100299678
0595376922 0149225753 0127248763 0165244762 0125283759 0095313714 0115291720 0094314752
0225425948 0095291719 0109301736 0149305673 0089273754 0164246747 0090258765 0300239757
0085312725 0125282718 0096307731 0290225725 0100280714 0069219776 0093256725 0083252778
0066282623 0125266743 0095312713 0038351611 0087400727 0189246746 0095280710 0069258774
0199270744 0054362645 0054373703 0189322748 0095248745 0038352609 0100291714 0080357744
0087313709 0060397664 0107256727 0086239765 0200266742 0175242750 0099259711 0149250730
0114377950 0100291714 0090358853 0040230590 0250276720 0037310691 0058328736 0045327681
0075238579 0075295713 0079242761 0130281745 0085313720 0159246740 0350186779 0150252731
0059268619 0099283829 0047284703 0075308718 0310303801 0090300743 0500238571 0119291760
0119268732 0035454785 0050344732 0055293743 0122339710 1500170631 0119242766 0800170627
0168267734 0040365733 0102279752 0062383873 0080286708 0110244775 0106222784 0122313747
0132281744 0499260715 0100252721 0130304804 0125284705 0095276715 0086257728 0221403767
0195248754 0120278719 0119507738 0102254775 0405273727 0118278753 0174244746 0069193738
0300252748 0105345734 0040411749 0265310702 0144280746 0100214850 0115307726 0050289765
0045454784 0219267733 0075346754 0070302739 0135279724 0099313750 0160261762 0077457780
0048286721 0064294744 0050234781 0150725877 0046350696 0037461773 0064481768 0070290747
0053301740 0054452783 0061153857 0135265700 0067234761 0055154803 0109257734 0064464785
0129272748 0032457815 0087233763 0119457801 0062383873 0050205833 0084269688 0047383876
0250401844 0040340722 0049265763 0039414737 0117243742 0129260765 0040461787 1450351870
0055288744 0199248764 0039163763 0085396832 0099327738 0098254724 0063413669 0040290748
0038459796 0030285745 0096307731 0175236768 0120278719 0137439794 0109291759 0077309730
0092310757 0042311692 0075284761 0069280712 0042426694 0075361714 0032320703 0041426695
0025331700 0045449814 0151270750 0060351718 0150294724 0060286749 0040456784 0073255723
0175255726 0195274719 0085302688 0195243740 0065308687 0160292760 0199271741 0149264742
0320382931 0099264741 0104256769 0300272719 0136276760 0125272726 0049196826 0095271725
0299294741 0165244739 0090226930 0112232764 0090251772 0399232780 0069329732 0095322752
0125320731 0065315697 0060306736 0132281744 0120343779 0035424696 0028294745 0087313709
0033447761 0119282712 0079304717 0066282623 0150382962 0025245861 0065287771 0065173973
0109321709 0047151765 0100236934 0040460786 0239187894 4500216878 0125279723 0100265806
0429240822 0149358797 0045236807 0175381957 3000276857 0100244999 0250384912 0055154803
0069154803 0300272719 0125346859 0050179615 0070183832 0039189889 0045199817 0300197819
0199417889 0100268798 0399422856 0066296748 0175413938 0095400846 0085197828 0078359797
0175277807 0075290773 0099305714 0131282710 0050355752 0055357709 0089315722 0095461761
0060412756 0065335717 0038460758 0085329681 0083459763 0360461798 0118323718 0033347689
0080339744 0149358797 0032317728 0057387656 0050460787 0080334649 0160292723 0095293723
0043439751 0050297687 0079272750 0125330864 0038287751 0045300735 0085278759 0060325698
0102431753 0100281711 0095312713 0070285743 0315240583 0775177616 0036326683 0145385957
0799269751 0045440753 0029295745 0057461782 0147239572 0060155647 0075471780 0109300728
0110316746 0084327732 0125319729 0038412716 0078344735 0099282755 1200248561 0089273754
0085273755 0150247582 0100239586 0078359797 0068244586 0079343717 0030240580 0095291750
0125283759 0084344737 0050306727 0075369737 0118319755 0119291760 0032456815 0090297683
0036293742 0050491797 0042450749 0066286745 0033288748 0100285772 0130280744 0900169613
0050191817 0040202859 0225425948 0200266742 0450331714 0089293722 0150470779 0098254724
0062307722 0250168780 0047381894 0120307726 0049205829 0179430943 0100280714 0073281751
0027206853 0049196826 0075346736 0128332927 0043360727 0060412716 0250175800 0090440744
0062463786 0081286748 0050186830 0114377950 0109301736 0095387747 0200192774 0310303801
0085312725 0036495762 0119365722 0080166626 0070188766 0138335651 0199200831 0119285723
0229183808 0041164827 0025230827 0120230766 0035177817 0044215857 0040171809 0185202871
0066323719 0079287748 0025295746 0074303713 0110394891 0150306805 0065321722 0399161634
0035243579 0040228589 0084306673 0075152669 0118282712 0500241581 0095312710 0300239580
0040434697 0109301736 0030455773 0085302688 0113260733 0125139800 0049160781 0080357744
0175175834 0120256714 0090258765 0087400727 0040177826 0039151742 0150289769 0400350858
0040412717 0075235900 0180274812 0028232835 0120278719 0070285750 0065415679 0039309691
0107256727 0065243897 0048302681 0092302726 0635258831 0087386919 0575177617 0199235903
0073315708 0036202834 0750186896 0125284705 0089273754 0096245739 0195243740 0070413743
0095400846 0350198832 0250207850 0189246746 0115291720 0100319731 0020165626 0123277713
0100265806 0045156806 0144280746 0199207853 0100299678 0033182801 0036197859 0145252769
0119300779 0950261723 0053301740 0050204823 0070413744 0055189818 0126204819 0160261762
0025160781 0080252724 0227259723 0085312725 0219267733 0035470780 0199268746 0650162634
0145257756 0118293723 0066282623 0061153857 0060440695 0100281711 0039394704 0087233763
0055298736 0375299797 0045178761 0130304804 0050194828 0069263938 0060188835 1099330920
0275160814 0161180770 0075196819 0019172809 0087200808 0089249921 0100252775 0050174790
0069221858 0099251759 0125171770 0057192815 0109291759 0080235586 0117243742 0050197731
0135279724 0149264742 0342422945 0040204858 0295232590 0168267734 0130280744 0095313714
0349266735 0199417889 0065146806 0035177787 0090226930 0092310757 0069229744 0050158812
0150192878 0065173811 0187183892 0137149848 0239187894 0120248723 0200158639 0195173759
0035165734 0060178825 0499205833 0050185827 1100189828 0126194835 0125261735 0055199819
0053386936 0075197976 0095189960 0075176795 0090174832 0450251848 0086239765 0043241578
0159246740 0027201855 0053301740 1400265734 0150725877 0125272726 0125283759 0024173803
0031177826 0112232764 0080177818 0225425948 1099187895 0085396832 0129245819 0119285723
0164246747 0133275726 0069191843 0100214850 0130281745 0026227848 0060179824 0075528823
0122198827 0094312723 0099259711 0028177811 0150306805 0300156651 0125329998 0054172780
0045189789 0070272810 0075236586 0045198812 0130304804 0080357744 1000115696 0217188790
0085302688 0030173809 0050186829 0099258764 0090187897 0280301842 0149225753 0035424697
0050176812 0080314698 0450204833 0075198826 0165244762 0174244746 0069193738 0129213638
0065233918 0159189784 0130157646 0185202871 0350673738 0045200812 0060414713 1590377807
0250238580 1395366920 0227187843 0999390893 0085316745 0900390966 0200393923 0104256769
0079242761 0129419943 0675225860 0200201834 0022346688 0199278781 0087312710 0125321721
1500331999 0259416893 0069322958 0050192840 0064206817 0094314752 0119347857 0590306795
0029162827 0114377950 0275241890 0075225867 0090358853 0095272725 0095238848 0080212851
0105301737 0125358796 0055368895 0090176832 0450333928 0099354847 0100252721 0090294999
0125330864 0099262762 0135200838 0155208950 1450351870 0050318970 0040214988 0144158943
0149418942 0129382923 0340318807 0069219776 0333328921 0200231823 0150206834 0089165768
0300203840 0200169795 0150185832 0027206853 0084170970 0255227847 0109339857 0065232917
0085230833 0075329865 0070404853 0069251929 0127248763 0095312713 0125266743 0028152742
0055202831 0329310800 0450195819 0055177818 0029185855 0125392893 0135201999 0136276760
0550224908 0065308687 0210200819 0195274719 0033177840 0130304804 0109313725 0049202853
0065163737 0070180847 0035209847 0100179776 0164327873 0120324875 0030193828 0095256725
0750268800 0595376922 0059297827 0100299678 0040155743 0062383873 0085192819 0105278719
0090358853 0750175629 0125171768 0090297683 0100192876 0169431943 0105279716 0050203801
0499205833 0059268619 0150192776 0060165737 0030176766 0039189889 0149305673 0084176804
0050157819 0017199823 0016174758 0028160781 0035164733 0115196820 0056176789 1200188889
0250207833 0160202813 0060206828 0032171808 0209202821 0029152740 0073137971 0045132826
0199283834 0058177788 0024172810 0035207854 0187291999 0059254800 0135210896 0195208849
0095248745 0060178829 0189322748 0050235838 0150279748 0150204855 2000334823 0300252748
0100230999 0250401844 0225425948 0162209849 0093256725 0299351996 0482390962 0040170794
0036183802 0055154803 0042203852 0059248828 0079166771 0080201832 0086257728 0150201832
0099313750 0039176764 0100145852 0175242750 0039151742 0157380962 1000271729 0106222784
1365172835 0165213966 0075175746 0040219868 0095276715 0090226930 0050170757 0736313800
0750405928 0099242999 0300173798 0095291719 0087386919 0300266740 0023207877 0250429944
0070252745 0275198812 0405273727 0038283623 0039394704 0275251776 0078209818 0499268806
0250291642 0100252721 0035243579 0035209847 0119225753 0045356610 0050185827 0075243760
0092190765 0122261733 0039151742 0220234900 0025290646 0129284636 0175253765 0052212789
0058328736 0325308919 0085281722 0130304804 0064206817 0049265763 0040276625 0149274718
0045230718 0040228589 0090259732 0060155647 0139418943 0219314775 0135260764 0066350617
0065287771 0125279629 0090297683 0072297731 0045259863 0040284622 0650162634 0050229725
0099230825 0050306727 0040290748 0099344727 0215261738 0095283764 0119278744 0325310712
0040264707 0050297687 0100299678 0110394891 0120343779 0299284648 0115275746 0056255714
0080274632 0060282871 0089248737 0073315708 0045303714 0080259732 0050280714 0050346615
0077329648 0125225741 0200276845 0055189818 0130248726 0190281711 0825286824 0115307726
0065173811 0080166626 0750175629 0049259730 0054231764 0129213638 0100214850 0120260762
0074303713 0027282623 0028355707 0575177617 0041230766 0069233787 0095312710 0018281622
0059268619 0150363644 0102256747 0179310729 0049353609 0095322752 0050242716 0099283829
0140294722 0055232692 0099262732 0041164827 0129284646 0800286644 0068244586 0150259766
0215315697 0075321726 0118278753 0080224738 0051230774 0175259737 0100291714 0085230833
0067239747 0130157646 0299317616 0038352609 0059193818 0062280714 0150304718 0069250730
0147239572 0250238580 0110239745 0099286745 0048302681 0100246771 0066397649 0120270729
0055256775 0069283623 0111236783 0500238571 0046229691 0075308718 0035345610 0075313716
0050197731 0050361638 0175293722 0149264716 0025213814 0040319677 0125246752 0075236586
0026179832 0075393642 0048286721 0054267708 0225286646 0120228766 0099269732 0129260765
0074250744 0192287648 0075246753 0116273757 0060351718 0120274722 0030239579 0100339647
0130303730 0069329732 0149225753 0060222734 0129277713 0102279752 0225279632 0028152742
0074283647 0033347689 0300239580 0450335646 0150272719 0106222784 0109300728 0124256755
0143276705 0025290646 0075332649 0040340722 0040288749 0062238748 0080259732 0110170618
0364274730 0110268716 0049335648 0110316746 0085226692 0028160781 0109275754 0144280746
0041283623 0050233589 0017281622 0112232764 0165244749 0085312725 0038352609 0079304717
0050360638 0107246729 0775177616 0069193738 0260136632 0249270718 0029152740 0042283646
0150247582 0030240580 0056303713 0125259761 0215348622 0190259733 0085278759 0072257751
0050179615 0040364610 0100355613 0060284747 0150277763 0100405646 0600293645 1000366612
0149248748 0095312713 0150229720 0800170627 0100274708 0085267720 0090272724 0059310713
0500241581 0080314698 0083200808 0160280740 0050225787 0199256747 0300254729 0096255747
0080334649 0032321675 0187274747 0060412756 0055219771 0054281622 0100234770 0058279627
0042264719 0038351611 0159250722 0050257721 0054373703 0054246770 0038283623 0035356708
0068289645 0034282623 0079281712 0138238744 0253346617 0055234781 0129281746 0026282623
0035336648 0075331649 0065321722 0041310705 0059248828 0034293736 0075266726 0093221783
0175261738 0100279644 0135240757 0084306673 0250356617 0159257731 0050363646 0045236807
0055306687 0129283638 0129285637 0016282623 0125256779 0100332645 0045260706 0085283701
0040238573 0089293722 0053402646 0050358647 0097266733 0085224781 0315240583 0100260787
0095232784 0115262728 2728285649 0080306676 0050356642 0090273733 0080334649 0098320684
0079211800 0032317728 0106252756 0109355797 0030239787 0079260762 0045218777 0059264763
1500170631 0079341716 0095291719 0099264741 0131245748 0067234761
;;;;
run;quit;

*          _       _   _
 ___  ___ | |_   _| |_(_) ___  _ __
/ __|/ _ \| | | | | __| |/ _ \| '_ \
\__ \ (_) | | |_| | |_| | (_) | | | |
|___/\___/|_|\__,_|\__|_|\___/|_| |_|

;

%utl_submit_r64('
source("c:/Program Files/R/R-3.3.2/etc/Rprofile.site",echo=T);
library(ggmap);
library(data.table);
library(haven);
data<-setDT(read_sas("d:/sd1/have.sas7bdat"));
map <- get_map(location = "austin", zoom = 12);
xbreaks <- seq(floor(min(data$LAT)), ceiling(max(data$LAT)), by = 0.01);
ybreaks <- seq(floor(min(data$LON)), ceiling(max(data$LON)), by = 0.01);
data$latbin <- xbreaks[cut(data$LAT, breaks = xbreaks, labels=F)];
data$longbin <- ybreaks[cut(data$LON, breaks = ybreaks, labels=F)];
datamat <- data[, list(ROOM_RATE = max(ROOM_RATE)),
                 by = c("latbin", "longbin")];
datamat <- merge(setDT(expand.grid(latbin = xbreaks, longbin = ybreaks)), datamat,
                 by = c("latbin", "longbin"), all.x = TRUE, all.y = FALSE);
datamat[is.na(ROOM_RATE), ]$ROOM_RATE <- 0;
pdf("d:/pdf/heatmap.pdf");
ggmap(map, extent = "device") +
  stat_contour(data = datamat, aes(x = longbin, y = latbin, z = ROOM_RATE,
               fill = ..level.., alpha = ..level..), geom = "polygon", binwidth = 100) +
  scale_fill_gradient(name = "Price", low = "green", high = "red") +
  guides(alpha = FALSE);
');




* simpler solution by same programmer;

%utl_submit_r64('
source("c:/Program Files/R/R-3.3.2/etc/Rprofile.site",echo=T);
library(ggmap);
library(data.table);
map <- get_map(location = "austin", zoom = 12);
data <- setDT(read.csv(file.choose(), stringsAsFactors = FALSE));
data[, average_rate_per_night := as.numeric(gsub(",", "",
    substr(average_rate_per_night, 2, nchar(average_rate_per_night))))]
pdf("d:/pdf/heatmap.pdf");
ggmap(map, extent = "device") +
    stat_summary_2d(data = data, aes(x = longitude, y = latitude,
        z = average_rate_per_night), fun = me, alpha = 0.6, bins = 30) +
    scale_fill_gradient(name = "Price", low = "green", high = "red");
');

* first solution with comments;


library(ggmap)
library(data.table)

map <- get_map(location = "austin", zoom = 12)
data <- setDT(read.csv(file.choose(), stringsAsFactors = FALSE))

# convert the rate from string into numbers
data[, average_rate_per_night := as.numeric(gsub(",", "",
       substr(average_rate_per_night, 2, nchar(average_rate_per_night))))]

# generate bins for the x, y coordinates
xbreaks <- seq(floor(min(data$latitude)), ceiling(max(data$latitude)), by = 0.01)
ybreaks <- seq(floor(min(data$longitude)), ceiling(max(data$longitude)), by = 0.01)

# allocate the data points into the bins
data$latbin <- xbreaks[cut(data$latitude, breaks = xbreaks, labels=F)]
data$longbin <- ybreaks[cut(data$longitude, breaks = ybreaks, labels=F)]

# Summarise the data for each bin
datamat <- data[, list(average_rate_per_night = mean(average_rate_per_night)),
                 by = c("latbin", "longbin")]

# Merge the summarised data with all possible x, y coordinate combinations to get
# a value for every bin
datamat <- merge(setDT(expand.grid(latbin = xbreaks, longbin = ybreaks)), datamat,
                 by = c("latbin", "longbin"), all.x = TRUE, all.y = FALSE)

# Fill up the empty bins 0 to smooth the contour plot
datamat[is.na(average_rate_per_night), ]$average_rate_per_night <- 0

# Plot the contours
ggmap(map, extent = "device") +
  stat_contour(data = datamat, aes(x = longbin, y = latbin, z = average_rate_per_night,
               fill = ..level.., alpha = ..level..), geom = 'polygon', binwidth = 100) +
  scale_fill_gradient(name = "Price", low = "green", high = "red") +
  guides(alpha = FALSE)


